// -----------------------------------------------------------------------------
// Flash => Javascript Object Bridge
//
var JFlashBridge = {
    items: {},

    bind: function(id, klass) {
        Symple.log('JFlashBridge: Bind: ', id, klass);
        this.items[id] = klass;
    },

    unbind: function(id) {
       delete this.items[id]
    },

    call: function() {
        //Symple.log('JFlashBridge: Call: ', arguments);
        var klass = this.items[arguments[0]];
        if (klass) {
            var method = klass[arguments[1]];
            if (method)
                method.apply(klass, Array.prototype.slice.call(arguments, 2));
            else
                Symple.log('JFlashBridge: No method: ', arguments[1]);
        }
        else
            Symple.log('JFlashBridge: No binding: ', arguments);
    },

    getSWF: function(movieName) {
        if (navigator.appName.indexOf("Microsoft") != -1)
            return window[movieName];
        return document[movieName];
    }
};


// -----------------------------------------------------------------------------
// Flash Engine
//
Symple.Media.registerEngine({
    id: 'Flash',
    name: 'Flash Player',
    // FLV-Speex is also an option, but currently omitted because of 
    // different flash player versions with inconsistent playback.
    formats: 'MJPEG, FLV, Speex', 
    preference: 40,
    support: (function() {
        return true;
    })()
});

Symple.Player.Engine.Flash = Symple.Player.Engine.extend({
    init: function(player) {
        Symple.log("SympleFlashEngine: Init");
        this._super(player);
        this.initialized = false;
        this.streamOnInit = false;
        this.id = "symple-player-" + Symple.randomString(6);
    },

    setup: function() {
        Symple.log("SympleFlashEngine: Create");
        this.initialized = false;
        this.player.screen.prepend('<div id="' + this.id + '">Flash version 10.0.0 or newer is required.</div>');
        
        JFlashBridge.bind(this.id, this);
        
        //Symple.log("SympleFlashEngine: SWF:", this.id, this.player.options.htmlRoot + '/symple.player.swf');
        swfobject.embedSWF(
            this.player.options.swf ? 
                this.player.options.swf : 
                this.player.options.htmlRoot + '/symple.player.swf', 
            this.id, '100%', '100%', '10.0.0',
            this.player.options.htmlRoot + '/playerProductInstall.swf', {
                //debug: true, // enable for debug output
            }, {
                quality: 'high',
                wmode: 'transparent',
                allowScriptAccess: 'sameDomain',
                allowFullScreen: 'true'
            }, {
                name: this.id
            });              
            
        
        // Flash swallows click events, so catch mousedown 
        // events and trigger click on screen element.        
        var self = this;
        this.player.screen.mousedown(function() {
            self.player.screen.trigger('click')
        });      
    },

    play: function(params) {        
        Symple.log("SympleFlashEngine: Play", params);        
        this.params = params;
        if (this.initialized) {
            Symple.log("SympleFlashEngine: Opening", params);
            this.swf().open(params);
            
            // Push through any pending candiates
            if (this.candidates) {
                for (var i = 0; i < this.candidates.length; i++) {
                    Symple.log("SympleFlashEngine: Add stored candidate", this.candidates[i]);
                    this.swf().addCandidate(this.candidates[i]);
                }
            }
        }
        else {            
            Symple.log("SympleFlashEngine: Waiting for SWF");
            this.streamOnInit = true;
        }
    },

    stop: function() {
        Symple.log("SympleFlashEngine: Stop");
        if (this.initialized) {
            this.swf().close();
            this.setState('stopped'); // No need to wait for callback
        }
    },

    swf: function() {
        return JFlashBridge.getSWF(this.id);
    },

    isJSReady: function() {
        Symple.log("SympleFlashEngine: JavaScript Ready: " + $.isReady);
        return $.isReady;
    },

    refresh: function() {
        Symple.log("SympleFlashEngine: Refresh");
        try {
          if (this.initialized)
            this.swf().refresh();
        } catch (e) {}
    },
    
    onRemoteCandidate: function(candidate) {
        if (this.params && this.params.url)
            throw "Cannot add candiate after explicit URL was provided."
           
        if (this.initialized) {
            Symple.log("SympleFlashEngine: Adding remote candiate ", candidate);
            this.swf().addCandiate(candidate);
        }        
        else {      
            Symple.log("SympleFlashEngine: Storing remote candiate ", candidate);
              
            // Store candidates while waiting for flash to load
            if (!this.candidates)
                this.candidates = [];      
            this.candidates.push(candidate);
        }            
    },
        
    onSWFLoaded: function() {
        Symple.log("SympleFlashEngine: Loaded");
        this.initialized = true;
        if (this.streamOnInit)     
            this.play(this.params);
    },

    onPlayerState: function(state, error) {
        // None, Loading, Playing, Paused, Stopped, Error
        state = state.toLowerCase();
        if (state == 'error' && (!error || error.length == 0))
            error = "Streaming connection to the host was lost."
        Symple.log("SympleFlashEngine: On state: ", state, error, this.player.state);
        if (state != 'none')
            this.setState(state, error);
    },

    onMetadata: function(data) {
        //Symple.log("SympleFlashEngine: Metadata: ", data);
        if (data && data.length) {
            var status = '';
            for (var i = 0; i < data.length; ++i) {
                status += data[i][0];
                status += ': ';
                status += data[i][1];
                status += '<br>';
            }
            this.player.displayStatus(status);
        }
    },

    onLogMessage: function(type, text) {
        Symple.log('SympleFlashEngine: ' + type + ': ' + text);
    }
});