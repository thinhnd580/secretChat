var JFlashBridge={items:{},bind:function(a,b){Symple.log("JFlashBridge: Bind: ",a,b),this.items[a]=b},unbind:function(a){delete this.items[a]},call:function(){var a=this.items[arguments[0]];if(a){var b=a[arguments[1]];b?b.apply(a,Array.prototype.slice.call(arguments,2)):Symple.log("JFlashBridge: No method: ",arguments[1])}else Symple.log("JFlashBridge: No binding: ",arguments)},getSWF:function(a){return-1!=navigator.appName.indexOf("Microsoft")?window[a]:document[a]}};Symple.Media.registerEngine({id:"Flash",name:"Flash Player",formats:"MJPEG, FLV, Speex",preference:40,support:function(){return!0}()}),Symple.Player.Engine.Flash=Symple.Player.Engine.extend({init:function(a){Symple.log("SympleFlashEngine: Init"),this._super(a),this.initialized=!1,this.streamOnInit=!1,this.id="symple-player-"+Symple.randomString(6)},setup:function(){Symple.log("SympleFlashEngine: Create"),this.initialized=!1,this.player.screen.prepend('<div id="'+this.id+'">Flash version 10.0.0 or newer is required.</div>'),JFlashBridge.bind(this.id,this),swfobject.embedSWF(this.player.options.swf?this.player.options.swf:this.player.options.htmlRoot+"/symple.player.swf",this.id,"100%","100%","10.0.0",this.player.options.htmlRoot+"/playerProductInstall.swf",{},{quality:"high",wmode:"transparent",allowScriptAccess:"sameDomain",allowFullScreen:"true"},{name:this.id});var a=this;this.player.screen.mousedown(function(){a.player.screen.trigger("click")})},play:function(a){if(Symple.log("SympleFlashEngine: Play",a),this.params=a,this.initialized){if(Symple.log("SympleFlashEngine: Opening",a),this.swf().open(a),this.candidates)for(var b=0;b<this.candidates.length;b++)Symple.log("SympleFlashEngine: Add stored candidate",this.candidates[b]),this.swf().addCandidate(this.candidates[b])}else Symple.log("SympleFlashEngine: Waiting for SWF"),this.streamOnInit=!0},stop:function(){Symple.log("SympleFlashEngine: Stop"),this.initialized&&(this.swf().close(),this.setState("stopped"))},swf:function(){return JFlashBridge.getSWF(this.id)},isJSReady:function(){return Symple.log("SympleFlashEngine: JavaScript Ready: "+$.isReady),$.isReady},refresh:function(){Symple.log("SympleFlashEngine: Refresh");try{this.initialized&&this.swf().refresh()}catch(a){}},onRemoteCandidate:function(a){if(this.params&&this.params.url)throw"Cannot add candiate after explicit URL was provided.";this.initialized?(Symple.log("SympleFlashEngine: Adding remote candiate ",a),this.swf().addCandiate(a)):(Symple.log("SympleFlashEngine: Storing remote candiate ",a),this.candidates||(this.candidates=[]),this.candidates.push(a))},onSWFLoaded:function(){Symple.log("SympleFlashEngine: Loaded"),this.initialized=!0,this.streamOnInit&&this.play(this.params)},onPlayerState:function(a,b){a=a.toLowerCase(),"error"!=a||b&&0!=b.length||(b="Streaming connection to the host was lost."),Symple.log("SympleFlashEngine: On state: ",a,b,this.player.state),"none"!=a&&this.setState(a,b)},onMetadata:function(a){if(a&&a.length){for(var b="",c=0;c<a.length;++c)b+=a[c][0],b+=": ",b+=a[c][1],b+="<br>";this.player.displayStatus(b)}},onLogMessage:function(a,b){Symple.log("SympleFlashEngine: "+a+": "+b)}}),Symple.Media={engines:{},registerEngine:function(a){return Symple.log("Register media engine: ",a),a.name&&"undefined"!=typeof a.preference&&"undefined"!=typeof a.support?(this.engines[a.id]=a,!0):(Symple.log("Cannot register invalid engine: ",a),!1)},hasEngine:function(a){return"object"==typeof this.engines[a]},supportsEngine:function(a){return!(!this.hasEngine(a)||!this.engines[a].support)},supportsFormat:function(a){return!!preferredEngine(a)},compatibleEngines:function(){var a,b=[];for(var c in this.engines)a=this.engines[c],0!=a.preference&&(Symple.log("Symple Media: Supported: ",a.name,a.support),1==a.support&&b.push(a));return b.sort(function(a,b){return a.preference<b.preference?1:a.preference>b.preference?-1:void 0}),b},preferredCompatibleEngine:function(a){var b,c=this.compatibleEngines(a);return b=c.length?c[0]:null,Symple.log("Symple Media: Preferred Engine: ",b),b},getOptimalVideoResolution:function(){var a=$(window).width(),b=a>800?800:a>640?640:a>480?400:a>320?320:a>240?240:a>160?160:a>128?128:96,c=.75*b;return[b,c]},buildURL:function(a){var b,c=[],d=a.address;b=d.scheme+"://"+d.host+":"+d.port+(d.uri?d.uri:"/");for(var e in a)"address"!=e&&c.push(encodeURIComponent(e)+"="+encodeURIComponent(a[e]));return c.push("rand="+Math.random()),b+="?",b+=c.join("&")},rescaleVideo:function(a,b,c,d){var e=c/d,f=1.33;return e>f?(b=d,a=b*f):(a=c,b=a/f),[a,b]},checkCandidate:function(a,b){Symple.log("Symple Media: Checking candidate: ",a);var c;if(window.XMLHttpRequest)c=new XMLHttpRequest;else{if(!window.ActiveXObject)return void b(a,!1);c=new ActiveXObject("Microsoft.XMLHTTP")}c.onreadystatechange=function(){2==c.readyState?b&&(Symple.log("Symple Media: Candidate result: ",c.readyState,c.status),b(a,200==c.status),b=null,setTimeout(function(){c.abort()},0)):4==c.readyState&&b&&(Symple.log("Symple Media: Candidate result: ",c.readyState,c.status),b(a,!0),b=null)},c.open("GET",a,!0),c.send(null)}},Symple.Player=Symple.Class.extend({init:function(a){if(this.options=Symple.extend({format:"MJPEG",engine:void 0,htmlRoot:"/javascripts/symple",element:".symple-player:first",fullscreenElement:void 0,onCommand:function(){},onStateChange:function(){},template:'            <div class="symple-player">                <div class="symple-player-message"></div>                <div class="symple-player-status"></div>                <div class="symple-player-loading"></div>                <div class="symple-player-screen"></div>                <div class="symple-player-controls">                    <a class="play-btn" rel="play" href="#">Play</a>                    <a class="stop-btn" rel="stop" href="#">Stop</a>                    <a class="fullscreen-btn" rel="fullscreen" href="#">Fullscreen</a>                </div>            </div>'},a),this.element=$(this.options.element),this.element.hasClass("symple-player")||(this.element.html(this.options.template),this.element=this.element.children(".symple-player:first")),!this.element.length)throw"Player element not found";if(this.screen=this.element.find(".symple-player-screen"),!this.screen.length)throw"Player screen element not found";if(this.message=this.element.find(".symple-player-message"),!this.message.length)throw"Player message element not found";if("undefined"==typeof this.options.engine){var b=Symple.Media.preferredCompatibleEngine(this.options.format);b&&(this.options.engine=b.id)}this.bindEvents(),this.playing=!1},setup:function(){var a=this.options.engine;if(!a)throw"Streaming engine not configured. Please set 'options.engine'";if(!Symple.Media.hasEngine(a))throw"Streaming engine not available: "+a;if("undefined"==typeof Symple.Player.Engine[a])throw"Streaming engine not found: "+a;if(!Symple.Media.supportsEngine(a))throw"Streaming engine not supported: "+a;this.engine=new Symple.Player.Engine[a](this),this.engine.setup(),this.element.addClass("engine-"+a.toLowerCase())},play:function(a){Symple.log("symple:player: Play: ",a);try{this.engine||this.setup(),"playing"!=this.state&&(this.setState("loading"),this.engine.play(a))}catch(b){throw this.setState("error"),this.displayMessage("error",b),b}},stop:function(){Symple.log("symple:player: Stop"),"stopped"!=this.state&&this.engine&&this.engine.stop()},destroy:function(){this.engine&&this.engine.destroy(),this.element.remove()},mute:function(a){a=!!a,Symple.log("SympleWebcam: Mute:",a),this.engine&&this.engine.mute&&this.engine.mute(a),this.element[a?"addClass":"removeClass"]("muted")},setState:function(a,b){Symple.log("symple:player: Set state:",this.state,"=>",a),this.state!=a&&(this.state=a,this.displayStatus(null),this.playing="playing"==a,b?this.displayMessage("error"==a?"error":"info",b):this.displayMessage(null),this.element.removeClass("state-stopped state-loading state-playing state-paused state-error"),this.element.addClass("state-"+a),this.options.onStateChange(this,a,b))},displayStatus:function(a){this.element.find(".symple-player-status").html(a?a:"")},displayMessage:function(a,b){Symple.log("symple:player: Display message:",a,b),b?this.message.html('<p class="'+a+'-message">'+b+"</p>").show():this.message.html("").hide()},bindEvents:function(){var a=this;this.element.find(".symple-player-controls a").unbind().bind("click tap",function(){return a.sendCommand(this.rel,$(this)),!1})},sendCommand:function(a,b){if(!this.options.onCommand||!this.options.onCommand(this,a,b))switch(a){case"play":this.play();break;case"stop":this.stop();break;case"mute":this.mute(!0);break;case"unmute":this.mute(!1);break;case"fullscreen":this.toggleFullScreen()}},getButton:function(a){return this.element.find('.symple-player-controls [rel="'+a+'"]')},toggleFullScreen:function(){var a=$(this.options.fullscreenElement)[0]||this.element[0];Symple.runVendorMethod(document,"FullScreen")||Symple.runVendorMethod(document,"IsFullScreen")?Symple.runVendorMethod(document,"CancelFullScreen"):Symple.runVendorMethod(a,"RequestFullScreen")}}),Symple.Player.Engine=Symple.Class.extend({init:function(a){this.player=a,this.fps=0,this.seq=0},support:function(){return!0},setup:function(){},destroy:function(){},play:function(a){this.params=a||{},this.params.url||"object"!=typeof a.address||(this.params.url=this.buildURL())},stop:function(){},pause:function(){},mute:function(){},setState:function(a,b){this.player.setState(a,b)},setError:function(a){Symple.log("Symple Player Engine: Error:",a),this.setState("error",a)},onRemoteCandidate:function(){Symple.log("Symple Player Engine: Remote candidates not supported.")},updateFPS:function(){if("undefined"==typeof this.prevTime&&(this.prevTime=(new Date).getTime()),this.seq>0){var a=(new Date).getTime();this.delta=this.prevTime?a-this.prevTime:0,this.fps=(1e3/this.delta).toFixed(3),this.prevTime=a}this.seq++},displayFPS:function(){this.updateFPS(),this.player.displayStatus(this.delta+" ms ("+this.fps+" fps)")},buildURL:function(){if(!this.params)throw"Streaming parameters not set";return this.params.address||(this.params.address=this.player.options.address),Symple.Media.buildURL(this.params)}}),Symple.Media.BrowserCompatabilityMsg='    <br>Download the latest version <a href="www.google.com/chrome/">Chrome</a> or     <a href="http://www.apple.com/safari/">Safari</a> to view this video stream.',Symple.Media.registerEngine({id:"MJPEG",name:"MJPEG Native",formats:"MJPEG",preference:60,defaults:{framing:"multipart"},support:function(){var a=navigator.userAgent,b=Symple.iOSVersion();return!(!a.match(/(Firefox|Chrome)/)&&!(b?6>b:a.match(/(Safari)/)))}()}),Symple.Player.Engine.MJPEG=Symple.Player.Engine.extend({init:function(a){this._super(a),this.img=null},play:function(a){if(Symple.log("MJPEG Native: Play",a),this.img)throw"Streaming already initialized";this._super(a);var b=this,c=!0;this.img=new Image,this.img.style.display="none",this.img.onload=function(){Symple.log("MJPEG Native: Success"),c?(b.img&&(b.img.style.display="inline"),b.setState("playing"),c=!1):b.displayFPS()},this.img.onerror=function(){b.setError("Streaming connection failed."+Symple.Media.BrowserCompatabilityMsg)},this.img.src=this.params.url,this.player.screen.prepend(this.img)},stop:function(){Symple.log("MJPEG Native: Stop"),this.cleanup(),this.setState("stopped")},cleanup:function(){this.img&&(this.img.style.display="none",this.img.src="#",this.img.onload=new Function,this.img.onerror=new Function,this.player.screen[0].removeChild(this.img),this.img=null)},setError:function(a){Symple.log("Symple MJPEG Engine: Error:",a),this.cleanup(),this.setState("error",a)}}),Symple.Media.registerEngine({id:"MJPEGWebSocket",name:"MJPEG WebSocket",formats:"MJPEG",preference:50,support:function(){return window.WebSocket=window.WebSocket||window.MozWebSocket,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,!(!window.WebSocket||2!==window.WebSocket.CLOSING||!window.URL)}()}),Symple.Player.Engine.MJPEGWebSocket=Symple.Player.Engine.extend({init:function(a){this._super(a),this.socket=null,this.img=null},play:function(a){if(this.active())throw"Streaming already active";this._super(a),this.createImage();var b=this,c=!0;Symple.log("MJPEG WebSocket: Play:",this.params),this.socket=new WebSocket(this.normalizeURL(this.params.url)),this.socket.onopen=function(){Symple.log("MJPEG WebSocket: Open")},this.socket.onmessage=function(a){Symple.log("MJPEG WebSocket: Message: ",a),b.active()||b.setError("Streaming failed"),c&&(b.setState("playing"),c=!1),Symple.log("MJPEG WebSocket: Frame",b,a.data);var d=window.URL.createObjectURL(a.data);b.img.onload=function(){window.URL.revokeObjectURL(d)},b.img.src=d,b.displayFPS()},this.socket.onerror=function(a){b.setError("Invalid MJPEG stream: "+a+".")}},stop:function(){Symple.log("MJPEG WebSocket: Stop"),this.cleanup(),this.setState("stopped")},active:function(){return null!==this.img&&null!==this.socket},cleanup:function(){Symple.log("MJPEG WebSocket: Cleanup"),this.img&&(this.img.style.display="none",this.img.src="#",this.img.onload=null,this.img.onerror=null,this.player.screen[0].removeChild(this.img),this.img=null),this.socket&&(Symple.log("MJPEG WebSocket: Cleanup: Socket: ",this.socket),this.socket.close(),this.socket=null)},createImage:function(){if(!this.img){this.img=new Image,this.img.style.width="100%",this.img.style.height="100%";this.img.onerror=function(a){Symple.log("MJPEG WebSocket: Image load error: ",a)},this.player.screen.append(this.img)}},normalizeURL:function(a){return a.replace(/^http/,"ws")},setError:function(a){Symple.log("MJPEG WebSocket: Error:",a),this.cleanup(),this.setState("error",a)}}),Symple.MultipartParser=Symple.Class.extend({init:function(a){this.engine=a,this.contentType=null,this.boundary=0,this.xhr.numParsed=0},process:function(a){var b=this.incrParse(a);b[0]>0&&(this.processPart(b[1]),this.xhr.numParsed+=b[0],a.length>this.xhr.numParsed&&this.processChunk())},processPart:function(a){a=a.replace(this.boundary+"\r\n","");for(var b=a.split("\r\n"),c={};/^[-a-z0-9]+:/i.test(b[0]);){var d=b.shift().split(":");c[d[0]]=d[1].trim(),this.contentType||"Content-Type"==d[0]&&(this.contentType=d[1].trim())}var e=b.join("\r\n");this.draw(e)},incrParse:function(a){if(a.length<1)return[-1];var b=a.indexOf(this.boundary);if(-1==b)return[-1];var c=a.indexOf(this.boundary,b+this.boundary.length);if(b>-1&&c>-1){var d=a.substring(b,c);return[c,d]}return[-1]}}),Symple.ChunkedParser=Symple.Class.extend({init:function(a){this.engine=a},process:function(a){for(var b,c=0,d=a.indexOf("/9j/");d>-1;)if(b=d,d=a.indexOf("/9j/",d+4),d>-1){var e=a.substr(b,d);this.engine.draw(e),c+=e.length}return c}}),Symple.Media.registerEngine({id:"MJPEGBase64MXHR",name:"MJPEG Base64 MXHR",formats:"MJPEG",defaults:{framing:"chunked",encoding:"Base64"},preference:30,support:function(){return"XMLHttpRequest"in window}()}),Symple.Player.Engine.MJPEGBase64MXHR=Symple.Player.Engine.extend({init:function(a){this._super(a),this.xhrID=0,this.xhrConn=null,this.contentType=null,this.img=null,this.errors=0},play:function(a){if(this.xhr)throw"Streaming already initialized";this._super(a),this.rotateConnection()},stop:function(){this.xhrConn&&(this.freeXHR(this.xhrConn),this.xhrConn=null),this.freeImage(this.img),this.img=null,this.player.screen.html(""),this.setState("stopped")},rotateConnection:function(){if(!this.params.url)throw"Invalid streaming URL";this.xhrID++;var a=this,b=this.createXHR();b.xhrID=this.xhrID,b.connecting=!0,b.cancelled=!1,b.onreadystatechange=function(){if(a.onReadyState.call(a,this),3==this.readyState)if(this.connecting){if(this.connecting=!1,a.xhrConn){if(a.xhrConn.xhrID==this.xhrID)throw"XHR ID mismatch";if(a.xhrConn===this)throw"XHR instance mismatch";a.xhrConn.onreadystatechange=new Function,a.xhrConn.abort(),delete a.xhrConn.responseText,a.xhrConn=null}a.xhrConn=this}else this.cancelled===!1&&this.responseText&&this.responseText.length>2097152&&(this.cancelled=!0,a.rotateConnection())},b.open("GET",this.params.url,!0),b.send(null),b=null},draw:function(a){this.img||(this.img=this.createImage(),this.player.screen.prepend(this.img)),this.img.src="data:"+this.contentType+";base64,"+a,this.displayFPS()},createXHR:function(){try{return new ActiveXObject("MSXML2.XMLHTTP.6.0")}catch(a){try{return new ActiveXObject("MSXML3.XMLHTTP")}catch(b){try{return new XMLHttpRequest}catch(c){throw new Error("Could not find supported version of XMLHttpRequest.")}}}},freeXHR:function(a){a.canceled=!0,a.abort(),a.onreadystatechange=new Function,delete a.responseText,a=null},createImage:function(a){var a=new Image;return a.self=this,a.style.zIndex=-1,a.onload=function(){Symple.log("MJPEGBase64MXHR: Onload"),"loading"==this.self.player.state&&this.self.setState("playing"),this.self.errors=0},a.onerror=function(){Symple.log("MJPEGBase64MXHR: Bad frame: ",frame.length,frame.substr(0,50),frame.substr(frame.length-50,frame.length)),this.self.errors++,5==this.self.errors&&"loading"==this.self.player.state&&this.self.setError("Streaming ended. Invalid media format.")},a},freeImage:function(a){a.onload=new Function,a.onerror=new Function,a.parentNode&&a.parentNode.removeChild(a),a=null},onReadyState:function(a){if(2==a.readyState){var b=a.getResponseHeader("Content-Type");b&&-1!=b.indexOf("multipart/")?(this.parser=new Symple.MultipartParser(this),this.parser.boundary="--"+b.split("=")[1]):this.parser=new Symple.ChunkedParser(this)}else if(3==a.readyState){isNaN(a.numParsed)&&(a.numParsed=0),this.contentType||(this.contentType=a.getResponseHeader("Content-Type")?a.getResponseHeader("Content-Type"):"image/jpeg");var c=a.responseText.length,d=a.responseText.substring(a.numParsed,c);d.length&&(a.numParsed+=this.parser.process(d))}else 4==a.readyState&&(this.onComplete(a.status),a.onreadystatechange=new Function,a=null)},onComplete:function(a){return this.player.playing?(stop(),void this.player.displayMessage("info","Streaming ended: Connection closed by peer.")):void this.setError(200==a?"Streaming connection failed: Not a multipart stream."+Symple.Media.BrowserCompatabilityMsg:"Streaming connection failed."+Symple.Media.BrowserCompatabilityMsg)}}),Symple.Media.registerEngine({id:"PseudoMJPEG",name:"Pseudo MJPEG",formats:"MJPEG, JPEG",preference:0,support:function(){return!0}()}),Symple.Player.Engine.PseudoMJPEG=Symple.Player.Engine.extend({init:function(a){this._super(a),this.lastImage=null,this.player.options.threads||(this.player.options.threads=2),$.ajaxSetup({cache:!1})},play:function(a){this._super(a),Symple.log("PseudoMJPEG: Play: ",this.params);for(var b=0;b<this.player.options.threads;++b)this.loadNext()},stop:function(){Symple.log("Symple PseudoMJPEG: stop"),this.player.playing=!1,this.lastImage&&(this.free(this.lastImage),this.lastImage=null),this.player.screen.html(""),this.setState("stopped")},loadNext:function(){var a=this,b=new Image;b.seq=this.seq,b.self=this,b.style.position="absolute",b.style.left=0,b.style.zIndex=-1,b.style.width="100%",b.style.height="100%",b.onload=function(){Symple.log("Symple PseudoMJPEG: Onload"),"loading"==a.player.state&&a.setState("playing"),a.show.call(a,this)},Symple.log("Symple PseudoMJPEG: loadNext",this.seq),this.seq<5&&(b.onerror=function(){Symple.log("Symple PseudoMJPEG: OnError"),a.free(b),a.setError("Streaming connection failed.")}),b.src=this.params.url+"&seq="+this.seq,this.player.screen.prepend(b)},show:function(a){if(Symple.log("Symple PseudoMJPEG: Show"),this.player.playing){if(this.lastImage&&this.lastImage.seq>a.seq)return this.free(a),void Symple.log("Symple PseudoMJPEG: Dropping: "+a.seq+" < "+this.lastImage.seq);a.style.zIndex=a.seq,this.lastImage&&this.free(this.lastImage),this.lastImage=a,this.displayFPS(),this.loadNext()}},free:function(a){a.parentNode.removeChild(a)},setError:function(a){Symple.log("Symple PseudoMJPEG: Error:",a),this.setState("error",a)}}),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.webkitURL||window.URL,Symple.Media.registerEngine({id:"Webcam",name:"Webcam Player",preference:0,support:function(){return"undefined"!=typeof navigator.getUserMedia}()}),Symple.Player.Engine.Webcam=Symple.Player.Engine.extend({init:function(a){Symple.log("SympleWebcam: Init"),this._super(a)},setup:function(){Symple.log("SympleWebcam: Setup"),"undefined"==typeof this.video&&(this.video=document.createElement("video"),this.video.autoplay=!0,this.player.screen.prepend(this.video))},destroy:function(){Symple.log("SympleWebcam: Destroy"),this.video&&(this.video.src="",this.video=null),this.localStream&&(!this.localStream.stop&&this.localStream.getTracks&&(this.localStream.stop=function(){this.getTracks().forEach(function(a){a.stop()})}),this.localStream.stop(),this.localStream=null)},play:function(a){Symple.log("SympleWebcam: Play",a);var b=this;navigator.getUserMedia({audio:a.audio,video:a.video},function(a){b.video.src=URL.createObjectURL(a),b.localStream=a,b.setState("playing")},function(a){b.setError("getUserMedia() Failed: "+a)})},stop:function(){this.video&&(this.video.src=""),this.setState("stopped")},mute:function(a){this.video&&(this.video.muted=a)},capture:function(a){a||(a=1);var b=this.video.videoWidth*a,c=this.video.videoHeight*a,d=document.createElement("canvas");d.width=b,d.height=c;var e=d.getContext("2d");return e.drawImage(this.video,0,0,b,c),d},toBlob:function(a,b,c){a=a||"image/jpeg",b=b||.75;var d=this.capture(c).toDataURL(a,b);return this._dataURItoBlob(d,a)},_dataURItoBlob:function(a,b){for(var c=atob(a.split(",")[1]),d=new ArrayBuffer(c.length),e=new Uint8Array(d),f=0;f<c.length;f++)e[f]=c.charCodeAt(f);return new Blob([d],{type:b})}}),window.RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection,window.RTCSessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,window.RTCIceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate,window.URL=window.webkitURL||window.URL,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,Symple.Media.registerEngine({id:"WebRTC",name:"WebRTC Player",formats:"VP8, VP9, Opus",preference:100,support:function(){return"undefined"!=typeof RTCPeerConnection}()}),Symple.Player.Engine.WebRTC=Symple.Player.Engine.extend({init:function(a){Symple.log("symple:player:webrtc: init"),this._super(a),this.rtcConfig=a.options.rtcConfig||{iceServers:[{url:"stun:stun.l.google.com:19302"}]},this.rtcOptions=a.options.rtcOptions||{optional:[{DtlsSrtpKeyAgreement:!0}]},this.mediaConstraints=a.options.mediaConstraints||{}},setup:function(){Symple.log("symple:player:webrtc: setup"),this._createPeerConnection(),"undefined"==typeof this.video&&(this.video=document.createElement("video"),this.video.autoplay=!0,this.player.screen.prepend(this.video),alert("creating"))},destroy:function(){Symple.log("symple:player:webrtc: destroy"),this.sendLocalSDP=null,this.sendLocalCandidate=null,this.video&&(this.video.src="",this.video=null),this.pc&&(this.pc.close(),this.pc=null)},play:function(a){if(Symple.log("symple:player:webrtc: play",a),a&&a.localMedia){var b=this;navigator.getUserMedia({audio:!a.disableAudio,video:!a.disableVideo},function(a){Symple.log("symple:player:webrtc: webcam playing"),b.video.src=URL.createObjectURL(a),b.pc.addStream(a),b.pc.createOffer(function(a){b._onLocalSDP(a)},function(a){b.setError("createOffer() Failed: "+a)})},function(a){b.setError("getUserMedia() Failed: "+a)})}},stop:function(){this.video&&(this.video.src=""),this.pc&&(this.pc.close(),this.pc=null),this.setState("stopped")},mute:function(a){a=a===!1?!1:!0,Symple.log("symple:player:webrtc: mute:",a),this.video&&this.video.prop("muted",a)},sendLocalSDP:new Function,sendLocalCandidate:new Function,recvRemoteSDP:function(a){if(Symple.log("symple:player:webrtc: recv remote sdp:",a),!a||!a.type||!a.sdp)throw"Invalid remote SDP";var b=this;this.pc.setRemoteDescription(new RTCSessionDescription(a),function(){Symple.log("symple:player:webrtc: sdp success")},function(a){console.error("symple:player:webrtc: sdp error:",a),b.setError("Cannot parse remote SDP offer")}),"offer"==a.type&&b.pc.createAnswer(function(a){b._onLocalSDP(a)},function(){b.setError("Cannot create local SDP answer")},null)},recvRemoteCandidate:function(a){if(Symple.log("symple:player:webrtc: recv remote candiate ",a),!this.pc)throw"The peer connection is not initialized";this.pc.addIceCandidate(new RTCIceCandidate(a))},_onLocalSDP:function(a){try{this.pc.setLocalDescription(a),this.sendLocalSDP(a)}catch(b){Symple.log("Failed to send local SDP:",b)}},_createPeerConnection:function(){if(this.pc)throw"The peer connection is already initialized";Symple.log("symple:player:webrtc: create RTCPeerConnnection with config: ",JSON.stringify(this.rtcConfig),JSON.stringify(this.rtcOptions));var a=this;this.pc=new RTCPeerConnection(this.rtcConfig,this.rtcOptions),this.pc.onicecandidate=function(b){b.candidate?(Symple.log("symple:player:webrtc: local candidate gathered:",b.candidate),a.sendLocalCandidate(b.candidate)):Symple.log("symple:player:webrtc: local candidate gathering complete")},this.pc.onaddstream=function(b){Symple.log("symple:player:webrtc: remote stream added"),a.setState("playing"),a.video.src=URL.createObjectURL(b.stream),a.video.play()},this.pc.onremovestream=function(b){Symple.log("symple:player:webrtc: remote stream removed:",b),a.video.stop(),a.video.src=""}}}),Symple.Media.iceCandidateType=function(a){return-1!=a.indexOf("typ relay")?"turn":-1!=a.indexOf("typ srflx")?"stun":-1!=a.indexOf("typ host")?"host":"unknown"};