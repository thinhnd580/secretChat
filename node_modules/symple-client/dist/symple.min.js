var Symple={VERSION:"0.9.0",filterObject:function(a,b,c){var d=[];for(var e in a)if(a.hasOwnProperty(e)){var f=a[e];if(b&&e!=b||c&&f!=c){if("object"==typeof f){var g=Symple.filterObject(f,b,c);g&&(d=d.concat(g))}}else d.push(a)}return d},deleteNested:function(a,b,c){for(var d in a){var e=a[d];b&&d!=b||c&&e!=c?"object"==typeof e&&Symple.deleteNested(e,b):delete a[d]}},countNested:function(a,b,c,d){void 0===d&&(d=0);for(var e in a)if(a.hasOwnProperty(e)){var f=a[e];b&&e!=b||c&&f!=c?"object"==typeof f&&(d=Symple.countNested(f,b,c,d)):d++}return d},traverse:function(a,b){for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];b(c,d),"object"==typeof d&&Symple.traverse(d,b)}},randomString:function(a){return Math.random().toString(36).slice(2)},merge:function(a,b){for(var c in b)try{b[c].constructor==Object?a[c]=merge(a[c],b[c]):a[c]=b[c]}catch(d){a[c]=b[c]}return a},extend:function(){for(var a=function(a,b){for(var c in b)hasOwnProperty.call(b,c)&&(a[c]=b[c]);return a},b=arguments[0],c=1;c<arguments.length;c++)b=a(b,arguments[c]);return b},runVendorMethod:function(a,b){for(var c,d,e=0,f=["webkit","moz","ms","o",""];e<f.length&&!a[c];){if(c=b,""==f[e]&&(c=c.substr(0,1).toLowerCase()+c.substr(1)),c=f[e]+c,d=typeof a[c],"undefined"!=d)return f=[f[e]],"function"==d?a[c]():a[c];e++}},parseISODate:function(a){var b=Date.parse(a);if(isNaN(b)){var c,d=0,e=[1,4,5,6,7,10,11];if(c=/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/.exec(a)){for(var f,g=0;f=e[g];++g)c[f]=+c[f]||0;c[2]=(+c[2]||1)-1,c[3]=+c[3]||1,"Z"!==c[8]&&void 0!==c[9]&&(d=60*c[10]+c[11],"+"===c[9]&&(d=0-d)),b=Date.UTC(c[1],c[2],c[3],c[4],c[5]+d,c[6],c[7])}}return new Date(b)},isMobileDevice:function(){return"ontouchstart"in document.documentElement},iOSVersion:function(a,b){return parseFloat((""+(/CPU.*OS ([0-9_]{1,5})|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent)||[0,""])[1]).replace("undefined","3_2").replace("_",".").replace("_",""))||!1},match:function(a,b){var c=!0;for(var d in a)if(!a.hasOwnProperty(d)||!b.hasOwnProperty(d)||b[d]!=a[d]){c=!1;break}return c},formatTime:function(a){function b(a){return 10>a?"0"+a:a}return b(a.getHours()).toString()+":"+b(a.getMinutes()).toString()+":"+b(a.getSeconds()).toString()+" "+b(a.getDate()).toString()+"/"+b(a.getMonth()).toString()},log:function(){"undefined"!=typeof console&&"undefined"!=typeof console.log&&console.log.apply(console,arguments)}};!function(a){var b=!1,c=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;a.Class=function(){},a.Class.extend=function(a){function d(){!b&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;b=!0;var f=new this;b=!1;for(var g in a)f[g]="function"==typeof a[g]&&"function"==typeof e[g]&&c.test(a[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,a[g]):a[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(Symple),Symple.Dispatcher=Symple.Class.extend({init:function(){this.listeners={}},on:function(a,b){"undefined"==typeof this.listeners[a]&&(this.listeners[a]=[]),"undefined"!=typeof b&&b.constructor==Function&&this.listeners[a].push(b)},clear:function(a,b){if("undefined"!=typeof this.listeners[a])for(var c=0;c<this.listeners[a].length;c++)this.listeners[a][c]==b&&this.listeners[a].splice(c,1)},dispatch:function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);if("undefined"!=typeof this.listeners[a])for(var c=0;c<this.listeners[a].length;c++)this.listeners[a][c].constructor==Function&&this.listeners[a][c].apply(this,b)}}),Symple.Manager=Symple.Class.extend({init:function(a){this.options=a||{},this.key=this.options.key||"id",this.store=[]},add:function(a){this.store.push(a)},remove:function(a){for(var b=null,c=0;c<this.store.length;c++)if(this.store[c][this.key]==a){b=this.store[c],this.store.splice(c,1);break}return b},get:function(a){for(var b=0;b<this.store.length;b++)if(this.store[b][this.key]==a)return this.store[b];return null},find:function(a){for(var b=[],c=0;c<this.store.length;c++)Symple.match(a,this.store[c])&&b.push(this.store[c]);return b},findOne:function(a){var b=this.find(a);return b.length?b[0]:void 0},last:function(){return this.store[this.store.length-1]},size:function(){return this.store.length}}),Symple.Client=Symple.Dispatcher.extend({init:function(a){this.options=Symple.extend({url:a.url?a.url:"http://localhost:4000",secure:!a.url||0!=a.url.indexOf("https")&&0!=a.url.indexOf("wss")?!1:!0,token:void 0},a),this._super(),this.peer=a.peer||{},this.peer.rooms=a.peer.rooms||[],this.roster=new Symple.Roster(this),this.socket=null},connect:function(){if(Symple.log("symple:client: connecting: ",this.options),self=this,this.socket)throw"The client socket is not null";this.socket=io.connect(this.options.url,this.options),this.socket.on("connect",function(){Symple.log("symple:client: connected"),self.socket.emit("announce",{token:self.options.token||"",user:self.peer.user||"",name:self.peer.name||"",type:self.peer.type||""},function(a){return Symple.log("symple:client: announced",a),200!=a.status?void self.setError("auth",a):(self.peer=Symple.extend(self.peer,a.data),self.roster.add(a.data),self.sendPresence({probe:!0}),self.dispatch("announce",a),void self.socket.on("message",function(a){if("object"==typeof a){switch(a.type){case"message":a=new Symple.Message(a);break;case"command":a=new Symple.Command(a);break;case"event":a=new Symple.Event(a);break;case"presence":a=new Symple.Presence(a),a.data.online?self.roster.update(a.data):self.roster.remove(a.data.id),a.probe&&self.sendPresence(new Symple.Presence({to:Symple.parseAddress(a.from).id}));break;default:o=a,o.type=o.type||"message"}if("string"!=typeof a.from)return void Symple.log("symple:client: invalid sender address: ",a);var b=self.roster.get(a.from);b?a.from=b:Symple.log("symple:client: got message from unknown peer: ",a),self.dispatch(a.type,a)}}))})}),this.socket.on("error",function(){self.dispatch("connect")}),this.socket.on("connecting",function(){Symple.log("symple:client: connecting"),self.dispatch("connecting")}),this.socket.on("reconnecting",function(){Symple.log("symple:client: reconnecting"),self.dispatch("reconnecting")}),this.socket.on("connect_failed",function(){Symple.log("symple:client: connect failed"),self.dispatch("connect_failed"),self.setError("connect")}),this.socket.on("disconnect",function(){Symple.log("symple:client: disconnect"),self.peer.online=!1,self.dispatch("disconnect")})},disconnect:function(){this.socket&&this.socket.disconnect()},online:function(){return this.peer.online},join:function(a){this.socket.emit("join",a)},leave:function(a){this.socket.emit("leave",a)},send:function(a,b){if(!this.online())throw"Cannot send messages while offline";if("object"!=typeof a)throw"Message must be an object";if("string"!=typeof a.type&&(a.type="message"),a.id||(a.id=Symple.randomString(8)),b&&(a.to=b),a.to&&"object"==typeof a.to&&(a.to=Symple.buildAddress(a.to)),a.to&&"string"!=typeof a.to)throw"Message `to` attribute must be an address string";if(a.from=Symple.buildAddress(this.peer),a.from==a.to)throw"Message sender cannot match the recipient";Symple.log("symple:client: sending",a),this.socket.json.send(a)},respond:function(a){this.send(a,a.from)},sendMessage:function(a,b){this.send(a,b)},sendPresence:function(a){a=a||{},a.data?a.data=Symple.merge(this.peer,a.data):a.data=this.peer,this.send(new Symple.Presence(a))},sendCommand:function(a,b,c,d){var e=this;a=new Symple.Command(a,b),this.send(a),c&&this.onResponse("command",{id:a.id},c,function(a){(d||202!=a.status&&406!=a.status)&&e.clear("command",c)})},addCapability:function(a,b){var c=this.peer;c&&("undefined"==typeof b&&(b=!0),"undefined"==typeof c.capabilities&&(c.capabilities={}),c.capabilities[a]=b)},removeCapability:function(a){var b=this.peer;b&&"undefined"!=typeof b.capabilities&&"undefined"!=typeof b.capabilities[a]&&(delete b.capabilities[key],this.sendPresence())},hasCapability:function(a,b){var c=this.roster.get(a);if(c){if("undefined"!=typeof c.capabilities&&"undefined"!=typeof c.capabilities[b])return c.capabilities[b]!==!1;if("undefined"!=typeof c.data&&"undefined"!=typeof c.data.capabilities&&"undefined"!=typeof c.data.capabilities[b])return c.data.capabilities[b]!==!1}return!1},getCapability:function(a,b){var c=this.roster.get(a);if(c){if("undefined"!=typeof c.capabilities&&"undefined"!=typeof c.capabilities[b])return c.capabilities[b];if("undefined"!=typeof c.data&&"undefined"!=typeof c.data.capabilities&&"undefined"!=typeof c.data.capabilities[b])return c.data.capabilities[b]}},setError:function(a,b){Symple.log("symple:client: fatal error",a,b),this.dispatch("error",a,b),this.socket&&this.socket.disconnect()},onResponse:function(a,b,c,d){"undefined"==typeof this.listeners[a]&&(this.listeners[a]=[]),"undefined"!=typeof c&&c.constructor==Function&&this.listeners[a].push({fn:c,after:d,filters:b})},clear:function(a,b){if(Symple.log("symple:client: clearing callback",a),"undefined"!=typeof this.listeners[a])for(var c=0;c<this.listeners[a].length;c++)this.listeners[a][c].fn===b&&String(this.listeners[a][c].fn)==String(b)&&(this.listeners[a].splice(c,1),Symple.log("symple:client: cleared callback",a))},dispatch:function(){this.dispatchResponse.apply(this,arguments)||this._super.apply(this,arguments)},dispatchResponse:function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);if("undefined"!=typeof this.listeners[a])for(var c=0;c<this.listeners[a].length;c++)if("object"==typeof this.listeners[a][c]&&"undefined"!=this.listeners[a][c].filters&&Symple.match(this.listeners[a][c].filters,b[0]))return this.listeners[a][c].fn.apply(this,b),"undefined"!=this.listeners[a][c].after&&this.listeners[a][c].after.apply(this,b),!0;return!1}}),Symple.Roster=Symple.Manager.extend({init:function(a){this._super(),this.client=a},add:function(a){if(Symple.log("symple:roster: adding",a),!a||!a.id||!a.user)throw"Cannot add invalid peer";this._super(a),this.client.dispatch("addPeer",a)},remove:function(a){a=Symple.parseAddress(a).id||a;var b=this._super(a);return Symple.log("symple:roster: removing",a,b),b&&this.client.dispatch("removePeer",b),b},get:function(a){return peer=this._super(a),peer?peer:this.findOne(Symple.parseAddress(a))},update:function(a){if(a&&a.id){var b=this.get(a.id);if(b)for(var c in a)b[c]=a[c];else this.add(a)}}}),Symple.parseAddress=function(a){var b={},c=a.split("|");return c.length>0&&(b.user=c[0]),c.length>1&&(b.id=c[1]),b},Symple.buildAddress=function(a){return(a.user?a.user+"|":"")+(a.id?a.id:"")},Symple.Message=function(a){"object"==typeof a&&this.fromJSON(a),this.type="message"},Symple.Message.prototype={fromJSON:function(a){for(var b in a)this[b]=a[b]},valid:function(){return this.id&&this.from}},Symple.Command=function(a){"object"==typeof a&&this.fromJSON(a),this.type="command"},Symple.Command.prototype={getData:function(a){return this.data?this.data[a]:null},params:function(){return this.node.split(":")},param:function(a){return this.params()[a-1]},matches:function(a){if(xparams=a.split(":"),xparams.length>this.params().length)return!1;for(var b=0;b<xparams.length;b++)if("*"!=xparams[b]&&xparams[b]!=this.params()[b])return!1;return!0},fromJSON:function(a){for(var b in a)this[b]=a[b]},valid:function(){return this.id&&this.from&&this.node}},Symple.Presence=function(a){"object"==typeof a&&this.fromJSON(a),this.type="presence"},Symple.Presence.prototype={fromJSON:function(a){for(var b in a)this[b]=a[b]},valid:function(){return this.id&&this.from}},Symple.Event=function(a){"object"==typeof a&&this.fromJSON(a),this.type="event"},Symple.Event.prototype={fromJSON:function(a){for(var b in a)this[b]=a[b]},valid:function(){return this.id&&this.from&&this.name}};